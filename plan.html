<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width" , initial-scale="1">
  <title></title>
  <!-- <link rel="stylesheet" href="css/bootstrap.css">
  <link href="/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" <link rel="stylesheet" href="resources/css/plugin/datepicker/bootstrap-datepicker.css">    <script src="/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="style2.css"> -->
  <!-- JQuery CDN -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" ?></script>
  <!-- 최신 자바스크립트 -->
  <script src="js/bootstrap.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/stylesheet.css">
  <link rel="stylesheet" href="css/style2.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" />
  <link rel="stylesheet" href="resources/css/plugin/datepicker/bootstrap-datepicker.css">
  <script src="/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  <link rel="stylesheet" href="plan.css">
</head>

<body>
  <style type="text/css">
    nav a:link {
      text-decoration: none;
      color: white;
    }

    nav a:visited {
      text-decoration: none;
      color: white;
    }

    nav a:active {
      text-decoration: none;
      color: white;
    }

    nav a:hover {
      text-decoration: underline;
      color: white;
    }

    /* #planUpBtn, #planDownBtn{
    visibility: hidden;
  } */
  </style>

  <!-- 상단 네비게이트 바 -->
  <nav class="navcolor navbar navbar-expand-lg text-uppercase navbar-fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand text-white" href="index.html">Writing Travel</a>
      <button class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false">
        <i class="fa fa-bars"></i>
      </button>

      <div class="collapse navbar-collapse " id="navbarResponsive">
        <ul class="navbar-nav ml-auto navbar-right">
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" id="logout_icon" style="color:white;">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- 상단 네비게이트 바 끝 -->

  <!-- 내부 내용 일 차, 카드 시작-->
  <section style="padding-top: 70px; padding-bottom: 70px;">
    <div class="container col-md-offset-3 col-md-6">
      <p id="country" style="display:inline; width:1200px;"><i class="fa fa-plane" aria-hidden="true" style="display:inline; float: left; width:50px;"></i>
        <div id="countryname" style="display:inline; float: left; width:200px;font-size: 30px; color: #2C3E50; "></div>
      </p>
      <button type="button" id="add_plan" class="float-right btn btn-outline-primary slideup" href="plan_add.html" onclick="window.open
      'plan_add.html','_blank','width=400px, height=600px, toolbars=no, scrollbar=no'); return false;">+</button>
      <!-- 일정순서 변경 버튼 -->
      <button type="button" id="moveThePlan" class="float-right mr-2 btn btn-info" onclick="moveThePlanEvent()"><i class="fa fa-hand-rock-o" aria-hidden="true"></i></button><br><br>

      <div id="innerID" style="padding-top:20px;">
        <!-- 데이와 돈 삽입 -->
        <!-- <div id="day_And_won"></div> -->
        <!-- 카드삽입 -->
        <!-- <div id="card_insert"></div> -->
      </div>
    </div>
  </section>
  <!-- 내부 내용 일 차, 카드 끝-->

  <!-- Footer -->
  <footer class="footer text-center">
    <div class="container">
      <a class="btn btn-outline-light btn-social mx-1" href="#">
        <i class="fab fa-facebook-square fa-3x"></i>
      </a>
      <a class="btn btn-outline-light btn-social mx-1" href="#">
        <i class="fab fa-twitter fa-3x"></i>
      </a>
      <a class="btn btn-outline-light btn-social mx-1" href="#">
        <i class="fab fa-instagram fa-3x"></i>
      </a>
    </div>
    </div>
  </footer>
  <!-- Footer 끝-->


  <!-- Copyright -->
  <section class="copyright py-4 text-center text-white">
    <div class="container">
      <small>Copyright &copy; WRITINGTRAVEL 2019</small>
    </div>
  </section>
  <!-- Copyright 끝 -->

  <!-- datepicker 전에 jquery 먼저 로드 -->
  <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="bootstrap-datepicker-master/dist/js/bootstrap-datepicker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <!-- 위에쓰면 자동 슬라이드가 안되고 밑에 쓰면 메뉴가 안닫힘 -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <!-- 자바스크립트 -->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
  <script type="text/javascript">
    //planDB values
    var code = sessionStorage.getItem('CODE');
    var plCnt;
    var day_day = new Array();
    var place = new Array();
    var plnum = new Array();
    var tit = new Array();
    var pic = new Array();
    var txt = new Array();
    var rod = new Array();
    var money = new Array();
    var dayCnt;
    var country;
    var day_y = new Array();
    var day_m = new Array();
    var day_d = new Array();
    var dayday = new Array();
    //
    $.ajax({
      url: "plan_fetch_.php",
      type: "POST",
      data: {
        code: code
      },
      success: function(result) {
        //alert(result);
        temp = result.split(",");
        country = temp[0];
        dayCnt = temp[1];
        plCnt = temp[2];
        //alert(country+"/ day"+ dayCnt+"/ plCnt"+ plCnt,"/");
        var j = 3;
        for (var i = 0; i < plCnt; i++) {
          day_day[i] = temp[j];
          j++;
          place[i] = temp[j];
          j++;
          plnum[i] = temp[j];
          j++;
          tit[i] = temp[j];
          j++;
          pic[i] = temp[j];
          j++;
          txt[i] = temp[j];
          j++;
          rod[i] = temp[j];
          j++;
          money[i] = temp[j];
          j++;
          //alert(day_day[i]+ "  "+ place[i]+"  "+plnum[i]+"   "+tit[i]+"   "+ pic[i]+"  "+ txt[i]+"  "+ rod[i]+"  "+money[i]);
          // document.getElementById('countryname').append(country);
        }  var z = j;
        //여행지 이름
        document.getElementById('countryname').innerHTML = country;

        for (var i = 0; i < dayCnt; i++) {
          day_y[i] = temp[z]; z++;
          day_m[i] = temp[z]; z++;
          day_d[i] = temp[z]; z++;
          dayday[i] = temp[z]; z++;
          //alert("TEST : "+ day_y[i]+" "+ day_m[i]+" "+ day_d[i]+ " "+dayday[i]);
        }

        //일 차, 카드
        for (var s = 0; s < dayCnt; s++) {
          //일 차 출력
          var chk = 0; //일 차의 첫 째인가 확인
          var startfind = 0;
          var endfind = 0;
          var findDay = new Array();
          var fdIdx = 0;
          var fdlen = 0;

          var printDay = s + 1;
          var infoAndCard = ""; //데이와 카드 담을 변수
          infoAndCard += "<div id='showday'>DAY ";
          //infoAndCard += printDay+"</div>";
          infoAndCard += printDay+" "+day_m[s]+"월 "+day_d[s]+"일"+"</div>";

          //해당 일 차에 해당하는 일정 시작 및 끝 인덱스 찾기
          for (var fd = 0; fd < plCnt; fd++) {
            if (day_day[fd] == s + 1) {
              findDay[fdIdx++] = fd;
            }
          }
          fdlen = findDay.length;

          startfind = findDay[0];
          endfind = findDay[fdlen - 1];

          for (var k = 0; k < plCnt; k++) {
            //카드 출력
            if (day_day[k] == s + 1) {

              //두 번 일정부터는 초기화 필요
              if (chk == 1) var infoAndCard = "";

              if (k == startfind) {
                infoAndCard += "<div id='cards'>";
              }

              //카드
              infoAndCard += '<div class="card"><div id="card_insert"><div class="card-body"><div class="row"><div class="col-md-3"><p id=place class="text-center">';
              infoAndCard += place[k] + '</p>';
              infoAndCard += '<img src="gallery/' + pic[k] + '" id=pl_pic class="img img-rounded img-fluid" onerror="this.style.display=';
              infoAndCard += "'none'";
              infoAndCard += '"/><br><br></div>';
              infoAndCard += '<div class="col-md-9"><p><a class="float-left" id=pl_name>';
              infoAndCard += tit[k] + '</a></p><br>';
              infoAndCard += '<div class="clearfix"></div><div id=pl_txt><p>';
              infoAndCard += txt[k] + '</p></div><p>';
              infoAndCard += '<a class="float-right btn btn-outline-primary ml-2" id="editBtn" onclick="GoEditPage(';
              infoAndCard += plnum[k] + ')">';
              infoAndCard += '<i class="fa fa-pencil"></i> edit</a>';
              infoAndCard += '<a class="float-right btn text-white btn-success"';
              infoAndCard += 'onclick="GoInsertMoneyPage(';
              // str += '"input_money.html","_blank","width=400px, height=600px, toolbars=no, scrollbar=no"); return false;">';
              infoAndCard += plnum[k] + ',' + money[k] + ')">';
              infoAndCard += ' <i class="fa fa-money"></i> ';
              infoAndCard += money[k] + '</a>'; //돈 추가 버튼
              infoAndCard += '<a class="float-right btn text-white btn-danger mr-2" id="delBtn" onclick="chkDel(';
              infoAndCard += plnum[k] + ')"><i class="fa fa-trash-o"></i> 삭제</a>' //삭제 버튼
              infoAndCard += '<a class="float-right btn text-white btn-info mr-2" name="plChangeBtn" id="planUpBtn" onclick="planUp(';
              infoAndCard += k + ')"><i class="fa fa-arrow-up" aria-hidden="true"></i></a>' //일정 위로
              infoAndCard += '<a class="float-right btn text-white btn-info mr-2" name="plChangeBtn" id="planDownBtn" onclick="planDown(';
              infoAndCard += k + ')"><i class="fa fa-arrow-down" aria-hidden="true"></i></a>' //일정 아래로
              infoAndCard += '</p></div></div></div>';


              // var test=$(str);
              // $('#card_insert').append(test);
              if (k == endfind) {
                infoAndCard += "</div>";
              }
              var _insert = $(infoAndCard);
              $('#innerID').append(_insert);
              chk = 1;

            } //if
          } //for k
        } //for s


      },
      error: function(request, status, error) {
        alert("planDB fatch failed code:" + "\n" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
      }
    });

    //add 버튼 이벤트
    $('#add_plan').click(function() {
      var url = "plan_add.html";
      var name = "plan add";
      var option = "width = 400, height = 600, location = no"
      window.open(url, name, option);
    })

    //로그아웃 이벤트
    $('#logout_icon').click(function() {
      $.ajax({
        url: "logout.php",
        type: "POST",
        success: function(result) {
          $(location).attr("href", "index.html");
          alert(result);
        }
      });
      //
    });
    //로그아웃 이벤트 종료
    $(function() {
      //id, code, day_day, place, pl_num, pl_tit,pl_pic, pl_txt, pl_rod, money

    })

    // 편집버튼 이벤트
    function GoEditPage(e) {
      //alert(e+"번 편집");
      location.href = "edit.html?" + e;


    }

    // 돈버튼 이벤트
    function GoInsertMoneyPage(e1, e2) {
      // str += '"input_money.html","_blank","width=400px, height=600px, toolbars=no, scrollbar=no"); return false;">';
      //alert(e+"번 편집");
      var url = "input_money.html?e1=" + e1 + "&e2=" + e2; //e1=plnum e2=money
      window.open(url, "", "width=400px,height=600px");
    }

    // 삭제버튼 이벤트
    function chkDel(e) {
      var plnum = e;
      $.ajax({
        url: "edit_delete_.php",
        type: "POST",
        data: {
          plnum
        },
        success: function(result) {
          alert(result);
          window.location.reload();
        },
        error: function(request, status, error) {
          alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
        }
      });
    }

    // 일정바꾸기 버튼 껐다 켜기
    var eventOn = 1;

    function moveThePlanEvent() {
      var Change = document.getElementsByName("plChangeBtn")[2];

      if (eventOn == 1) {
        // up.style.visibility = "visible";
        // down.style.visibility = "visible";
        // $("#planUpBtn").css("visibility","visible");
        // $("#planDownBtn").css("visibility","visible");
        for (var i = 0; i < plCnt * 2; i++) {
          document.getElementsByName("plChangeBtn")[i].style.visibility = "visible";
        }
        eventOn = 0;
      } else {
        // up.style.visibility = "hidden";
        // down.style.visibility = "hidden";
        // $("#planUpBtn").css("visibility","hidden");
        // $("#planDownBtn").css("visibility","hidden");
        for (var i = 0; i < plCnt * 2; i++) {
          document.getElementsByName("plChangeBtn")[i].style.visibility = "hidden";
        }

        eventOn = 1;
      }

    }

    var prePlNum;
    var nowPlNum;
    var preDay;
    var nowDay;
    //일정 위로


    function planUpdate(prePlNum, preDay, nowPlNum, nowDay) {
      $.ajax({
        url: "plan_update_.php",
        type: "POST",
        data: {
          code,
          prePlNum,
          preDay,
          nowPlNum,
          nowDay
        },
        success: function(result) {
          //alert(result);
          location.reload(true);
        },
        error: function(request, status, error) {
          alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
        }
      });
    }

    function planUp(idxNum) {
      if (idxNum == 0) alert("더 이상 위로 올릴 수 없습니다!");
      else {
        //일 차 동일 시, plnum 바꿈
        if (day_day[idxNum] == day_day[idxNum - 1]) {
          planUpdate(plnum[idxNum], day_day[idxNum], plnum[idxNum - 1], day_day[idxNum - 1]);
        }
        //일 차 다를 시, 일 차--
        else {
          day_day[idxNum] = day_day[idxNum - 1];
        }
      }
    }

    //일정 아래로
    function planDown(idxNum) {
      if (idxNum == plCnt - 1) alert("더 이상 아래로 내릴 수 없습니다!");
      else {
        //일 차 동일 시, plnum 순서 바꿈
        if (day_day[idxNum] == day_day[idxNum + 1]) {
          planUpdate(plnum[idxNum], day_day[idxNum], plnum[idxNum + 1], day_day[idxNum + 1]);
        }
        //일 차 다를 시, 일 차++
        else {
          day_day[idxNum] = day_day[idxNum + 1];
        }
      }
    }
  </script>
</body>

</html>
